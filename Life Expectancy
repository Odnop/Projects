str(df)
summary(df)

LifeExp <- as.numeric(df$Life_expectancy)
InfDth <- as.numeric(df$Infant_deaths)
U5dth<- as.numeric(df$Under_five_deaths)
AdultmìMort<- as.numeric(df$Adult_mortality)
Alcohol<- as.numeric(df$Alcohol)
HepatitisB<- as.numeric(df$Hepatitis_B)
Measles<- as.numeric(df$Measles)
BMI<- as.numeric(df$BMI)
Polio<- as.numeric(df$Polio)
Diphtheria<- as.numeric(df$Diphtheria)
HIV<- as.numeric(df$HIV)
GDP<- as.numeric(df$GDP)
lGDP<-log(GDP)
population<- as.numeric(df$Population)
Thinness1019<- as.numeric(df$Thinness_10_19)
Thinness59<- as.numeric(df$Thinness_5_9)
School<- as.numeric(df$Schooling)
Developed<- as.numeric(df$Developed)

df1 <- data.frame(LifeExp, InfDth, U5dth, AdultmìMort, Alcohol, HepatitisB, Measles, BMI, Polio, Diphtheria, HIV, lGDP, population, Thinness1019, Thinness59, School, Developed )
cormatrix <-cor(df1)
print(cormatrix)

#STIMATORE OLS
OLS <- lm(LifeExp ~ InfDth + U5dth + AdultmìMort + Alcohol + HepatitisB + Measles + BMI + Polio + Diphtheria + HIV + lGDP + population + Thinness1019 + Thinness59 + School + Developed)
summary(OLS)

#MM-ESTIMATOR (OLS ROBUSTO)
library(robustbase)
MM <- lmrob(LifeExp ~ InfDth + U5dth + AdultmìMort + Alcohol + HepatitisB + Measles + BMI + Polio + Diphtheria + HIV + lGDP + population + Thinness1019 + Thinness59 + School + Developed, control = lmrob.control(k.max = 500))
summary(MM)

#CROSS VALIDATION
library(glmnet)
X <- cbind(InfDth, U5dth, AdultmìMort, Alcohol, HepatitisB, Measles, BMI, Polio, Diphtheria, HIV, lGDP, population, Thinness1019, Thinness59, School, Developed)
Y <- LifeExp
lasso.cv<- cv.glmnet(X,Y)

#LASSO ESTIMATOR
best_lambda_cv10 = lasso.cv$lambda.min
best_model <- glmnet(X, Y,alpha=1, lambda = best_lambda_cv10)
beta_lasso <- coef(best_model)
print(beta_lasso)

#POST LASSO ESTIMATOR
post_lasso<- lm(LifeExp ~ InfDth + U5dth + AdultmìMort + Alcohol + HepatitisB + Measles + BMI + Polio + HIV + lGDP + Thinness1019 + School + Developed)
summary(post_lasso)
beta_post_lasso <- post_lasso$coefficients

#RESIDUALS BOX PLOT (OLS)
par(mfrow=c(1,3))
boxplot(OLS$residuals/summary(OLS)$sigma,xlab="standardized residuals")
plot(density(OLS$resid/summary(OLS)$sigma),xlab="standardized residuals",main="",ylab="Kernel Density")
boxplot(OLS$residuals,xlab="residuals")

#RESIDUALS BOX PLOT (M-ESTIMATOR)
par(mfrow=c(1,3))
boxplot(MM$residuals/summary(MM)$sigma,xlab="standardized residuals")
plot(density(MM$resid/summary(MM)$sigma),xlab="standardized residuals",main="",ylab="Kernel Density")
boxplot(MM$residuals,xlab="residuals")

#RESIDUALS BOX PLOT (LASSO)
#par(mfrow=c(1,3))
#boxplot(best_model$residuals/summary(best_model)$sigma,xlab="standardized residuals")
#plot(density(best_model$resid/summary(best_model)$sigma),xlab="standardized residuals",main="",ylab="Kernel Density")
#boxplot(best_model$residuals,xlab="residuals")


#RESIDUALS BOX PLOT (POST LASSO)
par(mfrow=c(1,3))
boxplot(post_lasso$residuals/summary(post_lasso)$sigma,xlab="standardized residuals")
plot(density(post_lasso$resid/summary(post_lasso)$sigma),xlab="standardized residuals",main="",ylab="Kernel Density")
boxplot(post_lasso$residuals,xlab="residuals")


#SIZE OF A TEST
  coefficients <- coef(OLS) 
  M= 10000
  b0_par <- coefficients[1]  
  b1_par <- coefficients[2]  
  b2_par <- coefficients[3]  
  b3_par <- coefficients[4]  
  b4_par <- 0  
  b5_par <- coefficients[6]
  b6_par <- coefficients[7]  
  b7_par <- coefficients[8] 
  b8_par <- coefficients[9]
  b9_par <- coefficients[10]  
  b10_par <- coefficients[11] 
  b11_par <- coefficients[12]
  b12_par <- coefficients[13]  
  b13_par <- coefficients[14]  
  b14_par <- coefficients[15]
  b15_par <- coefficients[16]  
  b16_par <- coefficients[17]
  b17_par <- coefficients[18]
  sd_par <- sd(Y)
  #
  t_test=1:M
  z_test=1:M
  for(i in 1:M){
    Y_sim = rnorm(length(Alcohol), b0_par + b1_par * InfDth + b2_par * U5dth + b3_par * AdultmìMort + b4_par * Alcohol + b5_par * HepatitisB + b6_par * Measles + b7_par * BMI + b8_par * Polio + b9_par * Diphtheria + b10_par * HIV + b11_par * lGDP + b12_par * population + b13_par * Thinness1019 + b14_par * Thinness59+ b15_par * School + b16_par * Developed , sd_par)
    lm.result=lm(Y_sim ~ InfDth + U5dth + AdultmìMort + Alcohol + HepatitisB + Measles + BMI + Polio + Diphtheria + HIV + lGDP + population + Thinness1019 + Thinness59 + School + Developed)
    t_stat=coef(summary(lm.result))[, "t value"]["Alcohol"]
    t_test[i]=1-(t_stat>=qt(0.025,length(Alcohol) - length(coefficients))&&t_stat<=qt(0.975,length(Alcohol) - length(coefficients)))
    z_test[i]=1-(t_stat>=qnorm(0.025)&&t_stat<=qnorm(0.975))
  }
  m_t=mean(t_test)
  m_z=mean(z_test)
  cat("Mean Test Size (t-test):", m_t)
  cat("Mean Test Size (z-test):", m_z)
  
  


#hist(LifeExp, col = "skyblue", main = "Istogramma della distribuzione di LifeExp", xlab = "Valori", ylab = "Frequenza")


#STATISTICA DESCRITTIVA DI LIFE EXPECTANCY
mean_LE<- mean(LifeExp)
var_LE<- var(LifeExp)
sd_LE<- sd(LifeExp)
Q1_LE<- quantile(LifeExp, probs = 0.25)
Q3_LE<- quantile(LifeExp, probs = 0.75)
interq_range <- Q3_LE - Q1_LE
interq_range <- as.numeric(interq_range)

curve(dnorm(x, mean = mean_LE, sd = sd_LE), add = TRUE, col = "red", lwd = 2)
abline(v = mean_LE, col = "red", lwd = 2)
median_LE<- median(LifeExp)
abline(v = median_LE, col = "blue", lwd = 2)
curve(dnorm(x, mean = mean_LE, sd = sd_LE), from = min(LifeExp), to = max(LifeExp), col = "red", lwd = 2, add = TRUE)
install.packages("ggplot2")
library(ggplot2)
ggplot(data=data.frame(x = InfDth + U5dth + AdultmìMort + Alcohol + HepatitisB + Measles + BMI + Polio + Diphtheria + HIV + GDP + population + Thinness1019 + Thinness59 + School + Developed), aes(x=x)) +
  geom_histogram(aes(LifeExp), binwidth= 0.2, fill= "blue", color="black", alpha=0.7, position="identity", width=0.5) + labs(title="Istogramma con colonnine sottili", x="valori", y="life expectancy")

#grafico_istogramma <- ggplot(data = df, aes(x = LifeExp)) +
#geom_histogram(binwidth = 5, fill = "skyblue", color = "black", alpha = 0.7) +
#labs(title = "Istogramma", x = "Valore", y = "Frequenza")

#grafico_frequenza <- ggplot(data=df, aes(x = LifeExp)) +
#geom_bar(aes(y = ..count..), fill = "skyblue", color = "black", alpha = 0.7) +
#labs(title = "Frequenza delle singole osservazioni", x = "Valore", y = "Frequenza")
#print(grafico_frequenza)


#GRAFICO FREQUENZE DI LIFE EXPECTANCY CON MEDIA, MEDIANA E QUARTILI
grafico_frequenza <- ggplot(data=df, aes(x = LifeExp)) +
  geom_bar(aes(y = after_stat(count)), fill = "black", color = "black", alpha = 0.7) +
  geom_vline(xintercept = mean_LE, color = "green2", linetype = "twodash", size = 1)+
  geom_vline(xintercept = median_LE, color = "red", linetype = "twodash", size = 1)+
  geom_vline(xintercept = Q1_LE, color = "orange2", linetype = "twodash", size = 1)+
  geom_vline(xintercept = Q3_LE, color = "orange2", linetype = "twodash", size = 1)+
  stat_function(fun = dnorm, args = list(mean = mean_LE, sd = sd_LE), geom = "area", fill = "black", alpha = 0.7)+
  labs(title = "Empirical distribution of Life Expectancy", x = "Life Expectancy", y = "Frequency")
grafico_frequenza


#BOXPLOT DI LIFE EXPECTANCY
boxplot(LifeExp)


df2015<-df[df$Year==2015,]

  
  
  
  # Creazione dello scatter plot
  plot(df2015$GDP,df2015$Life_expectancy, 
       main = "Scatter Plot tra LfEXP e GDP",
       xlab = "Variabile X", ylab = "Variabile Y",
       pch = 16, col = "black")
  lGDP1<-log(df2015$GDP)
  plot(lGDP1, df2015$Life_expectancy,
       main="Scatter plot tra LGDP e LfEXP",
       xlab = "Variabile X", ylab = "Variabile Y",
       pch = 16, col = "black")
 
   #BOXPLOT DI LIFE EXPECTANCY
  boxplot(LifeExp)
  data1 = df2015[,4:7]
  data2 = df2015[,c(20,8:19)]
  plot(data1)
  plot(data2)
  labs=dimnames(df2015)[[2]]
  par(mfrow=c(2,4))
  for(i in 4:20){
    boxplot(df2015[,i],xlab=labs[i],main="")
    par(mfrow=c(2,4))
    for(i in 8:20){
      boxplot(df2015[,i],xlab=labs[i],main="")
    }
